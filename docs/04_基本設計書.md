# BookLoop â€” åŸºæœ¬è¨­è¨ˆæ›¸ v1.1

> **æœ€çµ‚æ›´æ–°:** 2026-02-24
> **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ãƒ‰ãƒ©ãƒ•ãƒˆ
> **å¯¾è±¡ã‚¹ã‚³ãƒ¼ãƒ—:** Phase 1ï¼ˆMVPï¼‰
> **å‰æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:** BookLoop è¦ä»¶å®šç¾©æ›¸ v1.0
> **å¤‰æ›´å±¥æ­´:** v1.0 â†’ v1.1 ã‚»ãƒ«ãƒ•ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ ï¼ˆå…¨ 10 é …ç›®ä¿®æ­£ï¼‰

---

## 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¦‚è¦

### 1.1 ç›®çš„

æœ¬æ›¸ã¯ã€BookLoop MVPï¼ˆPhase 1ï¼‰ã®æŠ€è¡“çš„ãªè¨­è¨ˆæ–¹é‡ã‚’å®šç¾©ã™ã‚‹ã€‚è¦ä»¶å®šç¾©æ›¸ã§æ±ºå®šã—ãŸæ©Ÿèƒ½è¦ä»¶ãƒ»éæ©Ÿèƒ½è¦ä»¶ã‚’ã€å®Ÿè£…å¯èƒ½ãªæŠ€è¡“ä»•æ§˜ã«è½ã¨ã—è¾¼ã‚€ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚

### 1.2 å¯¾è±¡èª­è€…

- é–‹ç™ºè€…ï¼ˆæœ¬äºº = å€‹äººé–‹ç™ºï¼‰
- å°†æ¥ã®ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆå¼•ãç¶™ãç”¨ï¼‰

### 1.3 è¨­è¨ˆæ–¹é‡

| æ–¹é‡ | èª¬æ˜ |
|---|---|
| **å€‹äººé–‹ç™ºã«æœ€é©åŒ–** | é‹ç”¨ãƒ»ä¿å®ˆã‚³ã‚¹ãƒˆã‚’æœ€å°åŒ–ã€‚ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ€å¤§æ´»ç”¨ |
| **å‹å®‰å…¨æ€§ã®å¾¹åº•** | TypeScript ã‚’å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ä½¿ç”¨ã€‚API å¢ƒç•Œã‚‚å‹ã§å®ˆã‚‹ |
| **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ** | èª­æ›¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµã€‚å¾©å¸°æ™‚ã«åŒæœŸ |
| **æ®µéšçš„æ‹¡å¼µ** | Phase 2ï¼ˆAIï¼‰ãƒ»Phase 3ï¼ˆã‚½ãƒ¼ã‚·ãƒ£ãƒ«ï¼‰ã¸ã®æ‹¡å¼µã‚’é˜»å®³ã—ãªã„è¨­è¨ˆ |

---

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                         â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Mobile App     â”‚        â”‚      Web App        â”‚     â”‚
â”‚  â”‚  React Native    â”‚        â”‚     Next.js 14      â”‚     â”‚
â”‚  â”‚   (Expo SDK 52)  â”‚        â”‚   (App Router)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                             â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Embedded Replica  â”‚        â”‚     Fetch API       â”‚     â”‚
â”‚  â”‚ (libSQL / SQLite) â”‚        â”‚                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚          HTTPS              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚    Cloudflare Workers    â”‚
             â”‚     Hono Framework      â”‚
             â”‚     (API Server)        â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼             â–¼              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   Clerk    â”‚ â”‚  Turso   â”‚ â”‚  External    â”‚
  â”‚   (Auth)   â”‚ â”‚ (libSQL) â”‚ â”‚  APIs        â”‚
  â”‚            â”‚ â”‚          â”‚ â”‚              â”‚
  â”‚ â€¢ JWTç™ºè¡Œ   â”‚ â”‚ â€¢ Primaryâ”‚ â”‚ â€¢ Google     â”‚
  â”‚ â€¢ OAuth    â”‚ â”‚   (1ç®‡æ‰€) â”‚ â”‚   Books API  â”‚
  â”‚ â€¢ Webhook  â”‚ â”‚ â€¢ Replicaâ”‚ â”‚ â€¢ OpenBD     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   (Edge) â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layerï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰       â”‚
â”‚  React Native (Expo) / Next.js          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  API Gateway Layer                       â”‚
â”‚  Hono Router + Middleware               â”‚
â”‚  (èªè¨¼æ¤œè¨¼ / ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ / ãƒ¬ãƒ¼ãƒˆåˆ¶é™)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application Layer (Service)            â”‚
â”‚  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯                         â”‚
â”‚  (ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®— / ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Access Layer (Repository)         â”‚
â”‚  Drizzle ORM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Infrastructure Layer                    â”‚
â”‚  Turso (libSQL) / Clerk / External APIs â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æŠ€è¡“é¸å®šç†ç”±

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | é¸å®šç†ç”± |
|---|---|---|
| **ãƒ¢ãƒã‚¤ãƒ«** | React Native (Expo SDK 52) | TypeScript å…±æœ‰ã€‚EAS Build/Update ã§ OTA æ›´æ–°ã€‚å€‹äººé–‹ç™ºã®è² è·æœ€å°åŒ– |
| **Web** | Next.js 14 (App Router) | SSR/ISRã€‚Vercel ãƒ‡ãƒ—ãƒ­ã‚¤ã€‚React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå…±æœ‰ã®å¯èƒ½æ€§ |
| **API ã‚µãƒ¼ãƒãƒ¼** | Hono on Cloudflare Workers | è»½é‡ãƒ»é«˜é€Ÿã€‚Edge å®Ÿè¡Œã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€‚Workers ç„¡æ–™æ ãŒæ‰‹åšã„ |
| **ORM** | Drizzle ORM | å‹å®‰å…¨ã€‚libSQL å¯¾å¿œã€‚è»½é‡ã§ã‚¨ãƒƒã‚¸å®Ÿè¡Œã«é©åˆ |
| **DB** | Turso (libSQL) | SQLite äº’æ›ã€‚Embedded Replica ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã€‚ç„¡æ–™æ  9GB |
| **èªè¨¼** | Clerk | Google/Apple OAuth çµ„ã¿è¾¼ã¿æ¸ˆã€‚JWT ç™ºè¡Œã€‚Expo SDK å¯¾å¿œã€‚Webhook ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸ |
| **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°** | Cloudflare Workers (API) + Vercel (Web) + EAS (Mobile) | ãã‚Œãã‚Œã®å¼·ã¿ã‚’æ´»ç”¨ã€‚ã™ã¹ã¦ç„¡æ–™æ ã‚ã‚Š |
| **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°** | Sentry | ã‚¨ãƒ©ãƒ¼ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã€‚Expo/Next.js/Hono ã™ã¹ã¦å¯¾å¿œ |
| **æ›¸ç±ãƒ‡ãƒ¼ã‚¿** | Google Books API + OpenBD | ISBN â†’ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ã€‚2 ç³»çµ±ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 è¨­è¨ˆæ–¹é‡

- Turso (libSQL / SQLite äº’æ›) ã‚’ä½¿ç”¨ã€‚PostgreSQL å›ºæœ‰æ©Ÿèƒ½ã¯ä½¿ã‚ãªã„
- UUID ã¯ `TEXT` å‹ã§æ ¼ç´ï¼ˆSQLite ã« UUID å‹ãªã—ï¼‰
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯ ISO 8601 æ–‡å­—åˆ—ï¼ˆ`TEXT`ï¼‰ã§æ ¼ç´ã€‚ã‚¢ãƒ—ãƒªå´ã§ `Date` ã«å¤‰æ›
- Embedded Replica ã«ã‚ˆã‚‹ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èª­ã¿å–ã‚Šã‚’å‰æã¨ã—ãŸè¨­è¨ˆ
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã¯ ON DELETE CASCADE ã§å­¤ç«‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’é˜²æ­¢

### 3.2 ER å›³ï¼ˆæ¦‚è¦ï¼‰

```
users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚             â”‚
  â”‚ 1:N         â”‚ 1:N
  â–¼             â–¼
user_books    reading_sessions â”€â”€ 1:N â”€â”€ session_pauses
  â”‚             â”‚
  â”‚ N:1         â”‚ 1:N (optional)
  â–¼             â–¼
books         reading_notes
                â”‚
                â”‚ N:1 (optional)
                â–¼
              user_books

users â”€â”€ 1:1 â”€â”€ streaks
users â”€â”€ 1:N â”€â”€ streak_freezes
users â”€â”€ 1:1 â”€â”€ reading_goals
users â”€â”€ 1:N â”€â”€ daily_reading_logs
```

### 3.3 ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

#### 3.3.1 users â€” ãƒ¦ãƒ¼ã‚¶ãƒ¼

Clerk Webhook (`user.created`) ã§è‡ªå‹•ä½œæˆã€‚Clerk å´ãŒãƒã‚¹ã‚¿ãƒ¼ã€‚

```sql
CREATE TABLE users (
  id              TEXT PRIMARY KEY,          -- Clerk user_id (user_xxx)
  display_name    TEXT NOT NULL,
  avatar_url      TEXT,
  email           TEXT,
  timezone        TEXT NOT NULL DEFAULT 'Asia/Tokyo',
  created_at      TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at      TEXT NOT NULL DEFAULT (datetime('now'))
);
```

#### 3.3.2 reading_goals â€” èª­æ›¸ç›®æ¨™

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã« 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã€‚ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ä½œæˆã€‚

```sql
CREATE TABLE reading_goals (
  id                   TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id              TEXT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  days_per_week        INTEGER NOT NULL DEFAULT 5,    -- é€±ã®ç›®æ¨™èª­æ›¸æ—¥æ•° (1-7)
  books_per_month      INTEGER NOT NULL DEFAULT 2,    -- æœˆã®ç›®æ¨™èª­äº†å†Šæ•°
  minutes_per_session  INTEGER NOT NULL DEFAULT 30,   -- ç›®æ¨™ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰
  created_at           TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at           TEXT NOT NULL DEFAULT (datetime('now'))
);
```

#### 3.3.3 books â€” æ›¸ç±ãƒã‚¹ã‚¿

ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨ªæ–­ã§å…±æœ‰ã€‚åŒä¸€ ISBN ã¯ 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã€‚

```sql
CREATE TABLE books (
  id            TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  isbn          TEXT UNIQUE,                -- ISBN-13 (NULL = æ‰‹å‹•ç™»éŒ²)
  title         TEXT NOT NULL,
  author        TEXT,
  publisher     TEXT,
  cover_url     TEXT,
  total_pages   INTEGER,
  description   TEXT,
  genre         TEXT DEFAULT 'OTHER',
                -- NOVEL | BUSINESS | LIBERAL_ARTS | TECH
                -- | MANGA | ESSAY | ACADEMIC | OTHER
  published_at  TEXT,                       -- å‡ºç‰ˆæ—¥
  source        TEXT DEFAULT 'MANUAL',      -- GOOGLE_BOOKS | OPENBD | MANUAL
  created_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_books_isbn ON books(isbn);
CREATE INDEX idx_books_title ON books(title);
```

**ğŸ”„ v1.1 è¿½åŠ : æ‰‹å‹•ç™»éŒ²æ›¸ç±ã®é‡è¤‡åˆ¶å¾¡**

ISBN ãŒã‚ã‚‹æ›¸ç±ã¯ UNIQUE åˆ¶ç´„ã§é‡è¤‡ã‚’é˜²æ­¢ã§ãã‚‹ãŒã€æ‰‹å‹•ç™»éŒ²ï¼ˆISBN = NULLï¼‰ã®æ›¸ç±ã¯åŒä¸€ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è‘—è€…ã§é‡è¤‡ç™»éŒ²ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

- **æ–¹é‡:** ã‚¢ãƒ—ãƒªå±¤ã§ã€Œé¡ä¼¼æ›¸ç±ãƒã‚§ãƒƒã‚¯ã€ã‚’å®Ÿè£…ã™ã‚‹ã€‚DB åˆ¶ç´„ã§ã¯é˜²ãŒãªã„
- **ç†ç”±:** ã‚¿ã‚¤ãƒˆãƒ«å®Œå…¨ä¸€è‡´ã‚’å¼·åˆ¶ã™ã‚‹ã¨ã€ç‰ˆã®é•ã„ï¼ˆæ”¹è¨‚ç‰ˆç­‰ï¼‰ã‚’ç™»éŒ²ã§ããªããªã‚‹
- **å®Ÿè£…:**

```typescript
// BookService.createManual()
async function checkDuplicateManualBook(
  title: string, author: string | null
): Promise<Book | null> {
  // title ã®æ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ã€ãƒˆãƒªãƒ ã€å¤§æ–‡å­—å°æ–‡å­—çµ±ä¸€ï¼‰å¾Œã«å®Œå…¨ä¸€è‡´æ¤œç´¢
  const normalized = normalizeTitle(title);
  const existing = await db.select().from(books)
    .where(
      and(
        eq(books.title, normalized),
        author ? eq(books.author, author) : isNull(books.author),
        eq(books.source, 'MANUAL')
      )
    ).limit(1);
  return existing[0] ?? null;
}
```

- é‡è¤‡å€™è£œãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã« `DUPLICATE_BOOK_CANDIDATE` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€Œæ—¢å­˜ã®æ›¸ç±ã‚’ä½¿ã† / æ–°è¦ä½œæˆã™ã‚‹ã€ã®é¸æŠè‚¢ã‚’è¡¨ç¤º

#### 3.3.4 user_books â€” æœ¬æ£šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ Ã— æ›¸ç±ï¼‰

```sql
CREATE TABLE user_books (
  id            TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id       TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  book_id       TEXT NOT NULL REFERENCES books(id),
  status        TEXT NOT NULL DEFAULT 'WANT_TO_READ',
                -- WANT_TO_READ | READING | FINISHED
  current_page  INTEGER NOT NULL DEFAULT 0,
  rating        INTEGER,                    -- 1-5 (èª­äº†å¾Œã«è¨­å®šå¯)
  started_at    TEXT,                       -- èª­æ›¸é–‹å§‹æ—¥
  finished_at   TEXT,                       -- èª­äº†æ—¥
  created_at    TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at    TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id, book_id)
);

CREATE INDEX idx_user_books_user_status ON user_books(user_id, status);
CREATE INDEX idx_user_books_user_updated ON user_books(user_id, updated_at DESC);
```

#### 3.3.5 reading_sessions â€” èª­æ›¸ã‚»ãƒƒã‚·ãƒ§ãƒ³

```sql
CREATE TABLE reading_sessions (
  id                TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id           TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  book_id           TEXT NOT NULL REFERENCES books(id),
  session_type      TEXT NOT NULL DEFAULT 'TIMER',
                    -- TIMER | EXTERNAL | MANUAL
  external_app      TEXT,                     -- EXTERNALæ™‚: KINDLE | KOBO | OTHER
  started_at        TEXT NOT NULL,
  ended_at          TEXT,
  duration_sec      INTEGER NOT NULL DEFAULT 0,  -- â˜…å®Ÿèª­æ›¸æ™‚é–“ï¼ˆä¸€æ™‚åœæ­¢é™¤å¤–ï¼‰
  paused_total_sec  INTEGER NOT NULL DEFAULT 0,  -- â˜…ä¸€æ™‚åœæ­¢ã®åˆè¨ˆæ™‚é–“
  page_start        INTEGER,
  page_end          INTEGER,
  memo              TEXT,
  is_active         INTEGER NOT NULL DEFAULT 0,
  is_paused         INTEGER NOT NULL DEFAULT 0,  -- â˜…ä¸€æ™‚åœæ­¢ä¸­ãƒ•ãƒ©ã‚°
  local_date        TEXT NOT NULL,
  synced_at         TEXT,
  created_at        TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_sessions_user_active ON reading_sessions(user_id, is_active)
  WHERE is_active = 1;
CREATE INDEX idx_sessions_user_date ON reading_sessions(user_id, local_date DESC);
CREATE INDEX idx_sessions_user_book ON reading_sessions(user_id, book_id);
```

**ğŸ”„ v1.1 å¤‰æ›´: ä¸€æ™‚åœæ­¢å¯¾å¿œ**

v1.0 ã§ã¯ä¸€æ™‚åœæ­¢ã®è¨­è¨ˆãŒæ¬ ã‘ã¦ã„ãŸã€‚`duration_sec` ã®æ„å‘³ã‚’æ˜ç¢ºåŒ–ã—ã€ä¸€æ™‚åœæ­¢ã‚’è¨˜éŒ²ã™ã‚‹ä»•çµ„ã¿ã‚’è¿½åŠ ã€‚

- `duration_sec` = å®Ÿéš›ã®èª­æ›¸æ™‚é–“ï¼ˆä¸€æ™‚åœæ­¢æ™‚é–“ã‚’å«ã¾ãªã„ï¼‰
- `paused_total_sec` = ä¸€æ™‚åœæ­¢ã®ç´¯è¨ˆæ™‚é–“
- `is_paused` = ç¾åœ¨ä¸€æ™‚åœæ­¢ä¸­ã‹ã©ã†ã‹
- æ¤œç®—: `(ended_at - started_at) â‰’ duration_sec + paused_total_sec`

#### 3.3.6 session_pauses â€” ä¸€æ™‚åœæ­¢ãƒ­ã‚°ï¼ˆğŸ†• v1.1 è¿½åŠ ï¼‰

ä¸€æ™‚åœæ­¢ã®é–‹å§‹/å†é–‹ã‚’è¨˜éŒ²ã€‚`duration_sec` ã®ç®—å‡ºæ ¹æ‹ ã¨ã—ã¦ä¿æŒã€‚

```sql
CREATE TABLE session_pauses (
  id            TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  session_id    TEXT NOT NULL REFERENCES reading_sessions(id) ON DELETE CASCADE,
  paused_at     TEXT NOT NULL,              -- ä¸€æ™‚åœæ­¢é–‹å§‹æ™‚åˆ»
  resumed_at    TEXT,                       -- å†é–‹æ™‚åˆ»ï¼ˆNULL = ã¾ã ä¸€æ™‚åœæ­¢ä¸­ï¼‰
  duration_sec  INTEGER,                    -- ã“ã®ä¸€æ™‚åœæ­¢ã®ç§’æ•°
  created_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_session_pauses_session ON session_pauses(session_id);
```

**ä¸€æ™‚åœæ­¢ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«:**

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ â†’ (èª­æ›¸ä¸­)
  â†’ ä¸€æ™‚åœæ­¢  : session_pauses ã« INSERT (paused_at = now)
                reading_sessions.is_paused = 1
  â†’ å†é–‹      : session_pauses.resumed_at = now, duration_sec ã‚’è¨ˆç®—
                reading_sessions.is_paused = 0
                reading_sessions.paused_total_sec += duration_sec
  â†’ çµ‚äº†      : ã‚‚ã— is_paused = 1 ãªã‚‰è‡ªå‹•çš„ã«å†é–‹å‡¦ç†ã—ã¦ã‹ã‚‰çµ‚äº†
                duration_sec = (ended_at - started_at) - paused_total_sec
```

#### 3.3.7 streaks â€” ã‚¹ãƒˆãƒªãƒ¼ã‚¯

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã« 1 ãƒ¬ã‚³ãƒ¼ãƒ‰ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«æ›´æ–°ã€‚

```sql
CREATE TABLE streaks (
  id               TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id          TEXT NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
  current_streak   INTEGER NOT NULL DEFAULT 0,
  longest_streak   INTEGER NOT NULL DEFAULT 0,
  last_active_date TEXT,                    -- æœ€çµ‚èª­æ›¸æ—¥ (YYYY-MM-DD)
  updated_at       TEXT NOT NULL DEFAULT (datetime('now'))
);
```

#### 3.3.8 streak_freezes â€” ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ•ãƒªãƒ¼ã‚º

```sql
CREATE TABLE streak_freezes (
  id          TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  used_date   TEXT NOT NULL,                -- é©ç”¨æ—¥ (YYYY-MM-DD)
  month       TEXT NOT NULL,                -- æœˆ (YYYY-MM) â€»æœˆ2å›åˆ¶é™ã®åˆ¤å®šç”¨
  activated_at TEXT NOT NULL,               -- â˜…ç™ºå‹•æ“ä½œã‚’è¡Œã£ãŸæ—¥æ™‚
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id, used_date)
);

CREATE INDEX idx_freezes_user_month ON streak_freezes(user_id, month);
```

**ğŸ”„ v1.1 å¤‰æ›´: ãƒ•ãƒªãƒ¼ã‚ºç™ºå‹•ãƒ«ãƒ¼ãƒ«ã®æ˜ç¢ºåŒ–**

| ãƒ«ãƒ¼ãƒ« | å®šç¾© |
|---|---|
| ç™ºå‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚° | **å½“æ—¥ã®ã¿**ã€‚ç¿Œæ—¥ä»¥é™ã®äº‹å‰äºˆç´„ã¯ä¸å¯ |
| ç™ºå‹•æœŸé™ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ TZ ã®å½“æ—¥ 23:59:59 ã¾ã§ |
| æœˆä¸Šé™ | 2 å›/æœˆï¼ˆ`month` ã‚«ãƒ©ãƒ ã§ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| åŠ¹æœ | ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ç¶­æŒï¼ˆåŠ ç®—ã¯ã—ãªã„ï¼‰ |
| åˆ¶ç´„ | æ—¢ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¨˜éŒ²ã•ã‚ŒãŸæ—¥ã«ã¯ãƒ•ãƒªãƒ¼ã‚ºä¸å¯ï¼ˆä¸è¦ãªã®ã§ï¼‰ |

- **ç†ç”±:** ã€Œäº‹å‰äºˆç´„ã€ã‚’è¨±å¯ã™ã‚‹ã¨ã€Œãƒ•ãƒªãƒ¼ã‚ºã‚’ä½¿ã„å¿˜ã‚ŒãŸç¿Œæ—¥ã«é¡ã£ã¦ç™ºå‹•ã€ã¨ã„ã†ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒå¢—ãˆã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—ãŒè¤‡é›‘ã«ãªã‚‹ã€‚MVP ã§ã¯å½“æ—¥ç™ºå‹•ã®ã¿ã¨ã—ã€ã‚·ãƒ³ãƒ—ãƒ«ã«ä¿ã¤

#### 3.3.9 reading_notes â€” èª­æ›¸ãƒ¡ãƒ¢

```sql
CREATE TABLE reading_notes (
  id          TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id     TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  book_id     TEXT NOT NULL REFERENCES books(id),
  session_id  TEXT REFERENCES reading_sessions(id),  -- NULL = ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤–ãƒ¡ãƒ¢
  content     TEXT NOT NULL,
  page_number INTEGER,
  created_at  TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at  TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_notes_user_book ON reading_notes(user_id, book_id);
```

#### 3.3.10 daily_reading_logs â€” æ—¥æ¬¡èª­æ›¸ãƒ­ã‚°ï¼ˆé›†è¨ˆç”¨ï¼‰

ã‚¹ãƒˆãƒªãƒ¼ã‚¯åˆ¤å®šã¨çµ±è¨ˆã®é«˜é€ŸåŒ–ã®ãŸã‚ã€æ—¥æ¬¡ã§é›†è¨ˆãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿æŒã€‚

```sql
CREATE TABLE daily_reading_logs (
  id              TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
  user_id         TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  log_date        TEXT NOT NULL,            -- YYYY-MM-DDï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼TZï¼‰
  total_seconds   INTEGER NOT NULL DEFAULT 0,
  session_count   INTEGER NOT NULL DEFAULT 0,
  pages_read      INTEGER NOT NULL DEFAULT 0,
  created_at      TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at      TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id, log_date)
);

CREATE INDEX idx_daily_logs_user_date ON daily_reading_logs(user_id, log_date DESC);
```

**ğŸ”„ v1.1 è¿½åŠ : daily_reading_logs ã®æ›´æ–°ãƒ«ãƒ¼ãƒ«**

`daily_reading_logs` ã¯éæ­£è¦åŒ–ã•ã‚ŒãŸé›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚Šã€å¸¸ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†æ§‹ç¯‰å¯èƒ½ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

| ãƒˆãƒªã‚¬ãƒ¼ | æ›´æ–°æ–¹æ³• |
|---|---|
| ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆTIMER / EXTERNALï¼‰ | å½“æ—¥åˆ†ã® UPSERTï¼ˆåŠ ç®—ï¼‰ |
| ã‚ã¨ã‹ã‚‰è¨˜éŒ²ï¼ˆMANUALï¼‰ | **å¯¾è±¡æ—¥ã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å†é›†è¨ˆ** |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆå°†æ¥ï¼‰ | **å¯¾è±¡æ—¥ã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å†é›†è¨ˆ** |

```typescript
// ã‚ã¨ã‹ã‚‰è¨˜éŒ² or ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤æ™‚
async function rebuildDailyLog(userId: string, date: string) {
  const sessions = await db.select({
    totalSec: sql`COALESCE(SUM(duration_sec), 0)`,
    count: sql`COUNT(*)`,
    pages: sql`COALESCE(SUM(
      CASE WHEN page_end IS NOT NULL AND page_start IS NOT NULL
           THEN page_end - page_start ELSE 0 END
    ), 0)`,
  })
  .from(readingSessions)
  .where(
    and(
      eq(readingSessions.userId, userId),
      eq(readingSessions.localDate, date),
      eq(readingSessions.isActive, 0)  // å®Œäº†æ¸ˆã¿ã®ã¿
    )
  );

  // UPSERT: ã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æŒ¿å…¥
  await db.insert(dailyReadingLogs)
    .values({
      userId, logDate: date,
      totalSeconds: sessions[0].totalSec,
      sessionCount: sessions[0].count,
      pagesRead: sessions[0].pages,
    })
    .onConflictDoUpdate({
      target: [dailyReadingLogs.userId, dailyReadingLogs.logDate],
      set: {
        totalSeconds: sessions[0].totalSec,
        sessionCount: sessions[0].count,
        pagesRead: sessions[0].pages,
        updatedAt: new Date().toISOString(),
      },
    });
}
```

---

## 4. API è¨­è¨ˆ

### 4.1 è¨­è¨ˆæ–¹é‡

- RESTful è¨­è¨ˆã€‚ãƒªã‚½ãƒ¼ã‚¹æŒ‡å‘ã® URL æ§‹é€ 
- Hono ã® RPC ãƒ¢ãƒ¼ãƒ‰ (`hc`) ã§å‹å®‰å…¨ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆ
- å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« Clerk JWT èªè¨¼ãŒå¿…è¦ï¼ˆWebhook ã‚’é™¤ãï¼‰
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ Zod ã§å®šç¾©ï¼ˆ`packages/shared/validators` ã«é…ç½®ï¼‰
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¯ Cursor ãƒ™ãƒ¼ã‚¹ï¼ˆ`cursor` + `limit`ï¼‰

### 4.2 ãƒ™ãƒ¼ã‚¹ URL

```
Production:  https://api.bookloop.app
Staging:     https://api-staging.bookloop.app
```

### 4.3 å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼

```
Authorization: Bearer <clerk_jwt>
Content-Type: application/json
X-Timezone: Asia/Tokyo          -- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³
X-Request-Id: <uuid>            -- ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡ç”¨
```

### 4.4 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

#### 4.4.1 èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼

| Method | Path | èª¬æ˜ | èªè¨¼ |
|---|---|---|---|
| POST | `/webhooks/clerk` | Clerk Webhook å—ä¿¡ | Svixç½²åæ¤œè¨¼ |
| GET | `/users/me` | è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾— | å¿…é ˆ |
| PATCH | `/users/me` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° | å¿…é ˆ |
| DELETE | `/users/me` | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆ30æ—¥çŒ¶äºˆï¼‰ | å¿…é ˆ |

#### 4.4.2 èª­æ›¸ç›®æ¨™

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/users/me/goals` | èª­æ›¸ç›®æ¨™å–å¾— |
| PUT | `/users/me/goals` | èª­æ›¸ç›®æ¨™æ›´æ–°ï¼ˆã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å«ã‚€ï¼‰ |

#### 4.4.3 æ›¸ç±

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/books/search?q={query}&type={isbn\|keyword}` | æ›¸ç±æ¤œç´¢ï¼ˆGoogle Books / OpenBDï¼‰ |
| GET | `/books/:bookId` | æ›¸ç±è©³ç´°å–å¾— |
| POST | `/books` | æ‰‹å‹•æ›¸ç±ç™»éŒ²ï¼ˆğŸ”„ é‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰ |

#### 4.4.4 æœ¬æ£š

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/bookshelf` | æœ¬æ£šä¸€è¦§å–å¾— |
| POST | `/bookshelf` | æœ¬æ£šã«è¿½åŠ ï¼ˆğŸ”„ æ›¸ç±ç‰¹å®šã¨æœ¬æ£šè¿½åŠ ã‚’åˆ†é›¢ã€‚å¾Œè¿°ï¼‰ |
| GET | `/bookshelf/:userBookId` | æœ¬æ£šæ›¸ç±è©³ç´°ï¼ˆé€²æ—ãƒ»çµ±è¨ˆãƒ»ãƒ¡ãƒ¢å«ã‚€ï¼‰ |
| PATCH | `/bookshelf/:userBookId` | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ»ãƒšãƒ¼ã‚¸æ›´æ–° |
| DELETE | `/bookshelf/:userBookId` | æœ¬æ£šã‹ã‚‰å‰Šé™¤ |

#### 4.4.5 èª­æ›¸ã‚»ãƒƒã‚·ãƒ§ãƒ³

| Method | Path | èª¬æ˜ |
|---|---|---|
| POST | `/sessions` | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆTIMER / EXTERNALï¼‰ |
| GET | `/sessions/active` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾— |
| PATCH | `/sessions/:sessionId` | ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆãƒ¡ãƒ¢è¿½åŠ ç­‰ï¼‰ |
| POST | `/sessions/:sessionId/pause` | ğŸ†• ä¸€æ™‚åœæ­¢ |
| POST | `/sessions/:sessionId/resume` | ğŸ†• å†é–‹ |
| POST | `/sessions/:sessionId/end` | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† |
| POST | `/sessions/manual` | ã‚ã¨ã‹ã‚‰è¨˜éŒ² |
| GET | `/sessions?bookId={bookId}&cursor={cursor}&limit={limit}` | ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´å–å¾— |

#### 4.4.6 ã‚¹ãƒˆãƒªãƒ¼ã‚¯

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/streaks` | ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯æƒ…å ±å–å¾— |
| GET | `/streaks/calendar?year={year}&month={month}` | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ |
| POST | `/streaks/freeze` | ãƒ•ãƒªãƒ¼ã‚ºç™ºå‹•ï¼ˆğŸ”„ å½“æ—¥ã®ã¿ï¼‰ |

#### 4.4.7 èª­æ›¸ãƒ¡ãƒ¢

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/notes?bookId={bookId}&cursor={cursor}&limit={limit}` | ãƒ¡ãƒ¢ä¸€è¦§å–å¾— |
| POST | `/notes` | ãƒ¡ãƒ¢ä½œæˆ |
| PATCH | `/notes/:noteId` | ãƒ¡ãƒ¢ç·¨é›† |
| DELETE | `/notes/:noteId` | ãƒ¡ãƒ¢å‰Šé™¤ |

#### 4.4.8 çµ±è¨ˆ

| Method | Path | èª¬æ˜ |
|---|---|---|
| GET | `/stats/summary` | ç´¯è¨ˆã‚µãƒãƒªãƒ¼ |
| GET | `/stats/weekly?date={date}` | é€±é–“çµ±è¨ˆ |
| GET | `/stats/monthly?year={year}&month={month}` | æœˆé–“çµ±è¨ˆ |

### 4.5 ä¸»è¦ API è©³ç´°è¨­è¨ˆ

#### 4.5.1 POST `/bookshelf` â€” æœ¬æ£šã«è¿½åŠ ï¼ˆğŸ”„ v1.1 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ï¼‰

v1.0 ã§ã¯ã€ŒISBN æ¤œç´¢ â†’ æ›¸ç±ä½œæˆ â†’ æœ¬æ£šè¿½åŠ ã€ã‚’ 1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è¡Œã£ã¦ã„ãŸãŒã€è²¬å‹™éå¤§ã®ãŸã‚åˆ†é›¢ã€‚

**æ–°ãƒ•ãƒ­ãƒ¼:**

```
[ãƒ‘ã‚¿ãƒ¼ãƒ³ A: æ¤œç´¢çµæœã‹ã‚‰è¿½åŠ ]
  1. GET /books/search?q=xxx â†’ å€™è£œãƒªã‚¹ãƒˆå–å¾—
  2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå€™è£œã‚’é¸æŠ
  3. POST /bookshelf { bookId: "é¸æŠã—ãŸæ›¸ç±ID" }
     â†’ books ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²ãªã‚‰è‡ªå‹• INSERT â†’ user_books ã« INSERT

[ãƒ‘ã‚¿ãƒ¼ãƒ³ B: ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³]
  1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ ISBN ã‚’ã‚¹ã‚­ãƒ£ãƒ³
  2. GET /books/search?q={isbn}&type=isbn â†’ 1 ä»¶å–å¾—
  3. POST /bookshelf { bookId: "å–å¾—ã—ãŸæ›¸ç±ID" }

[ãƒ‘ã‚¿ãƒ¼ãƒ³ C: æ‰‹å‹•ç™»éŒ²]
  1. POST /books { title, author, totalPages } â†’ æ›¸ç±ä½œæˆï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
  2. POST /bookshelf { bookId: "ä½œæˆã•ã‚ŒãŸæ›¸ç±ID" }
```

```typescript
// Request
{
  bookId: string;                       // æ¤œç´¢çµæœ or æ‰‹å‹•ä½œæˆã§å–å¾—ã—ãŸ ID
  status?: "WANT_TO_READ" | "READING";  // default: WANT_TO_READ
}

// Response 201
{
  id: string;            // user_books.id
  book: { ... };
  status: string;
  createdAt: string;
}

// Error 409: BOOK_ALREADY_IN_SHELF
```

**`GET /books/search` å†…éƒ¨ã§ã®æ›¸ç±è‡ªå‹•ç™»éŒ²:**

```typescript
// books/search ã¯æ¤œç´¢çµæœã‚’è¿”ã™éš›ã«ã€
// Google Books / OpenBD ã®çµæœã‚’ books ãƒ†ãƒ¼ãƒ–ãƒ«ã« UPSERT ã™ã‚‹ï¼ˆISBN ãƒ™ãƒ¼ã‚¹ï¼‰
// â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å¸¸ã« bookId ã‚’ä½¿ã£ã¦ /bookshelf ã«è¿½åŠ ã§ãã‚‹
async function searchBooks(query: string, type: 'isbn' | 'keyword') {
  // 1. ã¾ãš DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ¤œç´¢
  const cached = await bookRepo.searchByQuery(query, type);
  if (cached.length > 0) return cached;

  // 2. Google Books API â†’ OpenBD ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  const external = await fetchFromExternalAPIs(query, type);

  // 3. å–å¾—çµæœã‚’ books ãƒ†ãƒ¼ãƒ–ãƒ«ã« UPSERTï¼ˆISBN ãŒã‚ã‚‹ã‚‚ã®ã®ã¿ï¼‰
  for (const book of external) {
    if (book.isbn) {
      await bookRepo.upsertByIsbn(book);
    }
  }

  return external;
}
```

#### 4.5.2 POST `/sessions/:sessionId/pause` â€” ä¸€æ™‚åœæ­¢ï¼ˆğŸ†• v1.1 è¿½åŠ ï¼‰

```typescript
// Request: (empty body)

// Response 200
{
  sessionId: string;
  isPaused: true;
  pausedAt: string;        // ISO 8601
  pauseCount: number;      // ã“ã® Session ã®ä¸€æ™‚åœæ­¢å›æ•°
}

// Error 400: SESSION_NOT_ACTIVE â€” ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé€²è¡Œä¸­ã§ãªã„
// Error 400: SESSION_ALREADY_PAUSED â€” æ—¢ã«ä¸€æ™‚åœæ­¢ä¸­
```

**è¨­è¨ˆåˆ¤æ–­: ä¸€æ™‚åœæ­¢ã‚’ã‚µãƒ¼ãƒãƒ¼ã§ç®¡ç†ã™ã‚‹ç†ç”±**

| é¸æŠè‚¢ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|---|---|---|
| A. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã¿ | ã‚·ãƒ³ãƒ—ãƒ«ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚å‹•ä½œ | duration_sec ã®ä¿¡é ¼æ€§ãŒä¸‹ãŒã‚‹ã€‚ä¸æ­£æ“ä½œãŒå®¹æ˜“ |
| B. ã‚µãƒ¼ãƒãƒ¼ã§ç®¡ç† | duration_sec ã®ç®—å‡ºæ ¹æ‹ ãŒæ˜ç¢ºã€‚æ¤œç®—å¯èƒ½ | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã« API ã‚’å©ã‘ãªã„ |
| **æ¡ç”¨: B + ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯** | é€šå¸¸ã¯ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¸€æ™‚åœæ­¢ã‚’è¨˜éŒ²ã—ã€sync æ™‚ã« session_pauses ã‚’ãƒãƒƒãƒé€ä¿¡ | â€” |

#### 4.5.3 POST `/sessions/:sessionId/resume` â€” å†é–‹ï¼ˆğŸ†• v1.1 è¿½åŠ ï¼‰

```typescript
// Request: (empty body)

// Response 200
{
  sessionId: string;
  isPaused: false;
  resumedAt: string;
  pauseDurationSec: number;    // ä»Šå›ã®ä¸€æ™‚åœæ­¢æ™‚é–“
  totalPausedSec: number;      // ç´¯è¨ˆä¸€æ™‚åœæ­¢æ™‚é–“
}

// Error 400: SESSION_NOT_PAUSED â€” ä¸€æ™‚åœæ­¢ä¸­ã§ãªã„
```

#### 4.5.4 POST `/sessions/:sessionId/end` â€” ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

```typescript
// Request
{
  pageStart?: number;
  pageEnd?: number;
  memo?: string;
}

// Response 200
{
  session: {
    id: string;
    durationSec: number;       // å®Ÿèª­æ›¸æ™‚é–“ï¼ˆä¸€æ™‚åœæ­¢é™¤å¤–ï¼‰
    pausedTotalSec: number;    // ä¸€æ™‚åœæ­¢åˆè¨ˆ
    wallClockSec: number;      // çµŒéæ™‚é–“ï¼ˆ= duration + pausedï¼‰
    pageStart: number | null;
    pageEnd: number | null;
    sessionType: string;
  };
  streak: {
    currentStreak: number;
    longestStreak: number;
    isNewRecord: boolean;
  };
  dailyLog: {
    totalSeconds: number;
    sessionCount: number;
  };
}
```

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«:**
- ä¸€æ™‚åœæ­¢ä¸­ã«çµ‚äº†ã—ãŸå ´åˆã€è‡ªå‹•çš„ã«å†é–‹å‡¦ç†ï¼ˆ`resumed_at` = `ended_at`ï¼‰ã—ã¦ã‹ã‚‰çµ‚äº†
- `duration_sec` = `(ended_at - started_at) - paused_total_sec`
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨ˆæ¸¬å€¤ã¨ã®ç…§åˆã¯å»ƒæ­¢ï¼ˆv1.0 ã®ã€Œ10% å·®ã€ãƒ«ãƒ¼ãƒ«ã‚’æ’¤å›ï¼‰ã€‚ã‚µãƒ¼ãƒãƒ¼ã® `started_at` / `ended_at` / `session_pauses` ã‹ã‚‰ç®—å‡ºã™ã‚‹å€¤ã‚’æ­£ã¨ã™ã‚‹
- `page_end > page_start` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- `page_end >= total_pages` ã®å ´åˆã€`status` ã‚’ `FINISHED` ã«è‡ªå‹•å¤‰æ›´
- `daily_reading_logs` ã‚’ UPSERT
- ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ

#### 4.5.5 POST `/sessions/manual` â€” ã‚ã¨ã‹ã‚‰è¨˜éŒ²

```typescript
// Request
{
  bookId: string;
  date: string;            // YYYY-MM-DDï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼TZï¼‰
  durationMin: number;     // åˆ†å˜ä½ï¼ˆ1ã€œ480ï¼‰
  pageStart?: number;
  pageEnd?: number;
  memo?: string;
}

// Response 201
// â†’ POST /sessions/:sessionId/end ã¨åŒã˜æ§‹é€ 
```

**ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«:**
- è¨˜éŒ²å¯èƒ½ãªæ—¥ä»˜ç¯„å›²: éå» 7 æ—¥ä»¥å†…
- åŒæ—¥ã«æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã£ã¦ã‚‚è¿½åŠ å¯èƒ½
- **ğŸ”„ v1.1:** `daily_reading_logs` ã¯åŠ ç®—ã§ã¯ãªã**å½“æ—¥åˆ†ã‚’å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å†é›†è¨ˆ**ï¼ˆ3.3.10 å‚ç…§ï¼‰
- ã‚¹ãƒˆãƒªãƒ¼ã‚¯å†è¨ˆç®—ã‚’å®Ÿè¡Œï¼ˆå¾Œè¿°ï¼‰

#### 4.5.6 GET `/bookshelf` â€” æœ¬æ£šä¸€è¦§

```typescript
// Query Parameters
{
  status?: "WANT_TO_READ" | "READING" | "FINISHED";
  sort?: "updated_at" | "title" | "author" | "created_at";
  order?: "asc" | "desc";
  cursor?: string;
  limit?: number;          // default: 20, max: 50
}

// Response 200
{
  items: [
    {
      id: string;
      book: {
        id: string;
        title: string;
        author: string | null;
        coverUrl: string | null;
        totalPages: number | null;
        genre: string;
      };
      status: string;
      currentPage: number;
      progress: number;     // 0.0 - 1.0
      updatedAt: string;
    }
  ];
  nextCursor: string | null;
  totalCount: number;
}
```

---

## 5. ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

### 5.1 æ¦‚è¦

ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¯ BookLoop ã®ç¿’æ…£åŒ–ã‚¨ãƒ³ã‚¸ãƒ³ã®æ ¸å¿ƒã€‚è¨ˆç®—ã®æ­£ç¢ºæ€§ã¨ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œãŒæœ€é‡è¦ã€‚

### 5.2 é€šå¸¸ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ›´æ–°

ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼ˆTIMER / EXTERNALï¼‰æ™‚ã¯**å·®åˆ†æ›´æ–°**ã§é«˜é€Ÿã«å‡¦ç†ã™ã‚‹ã€‚

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†
       â”‚
       â–¼
daily_reading_logs ã‚’ UPSERTï¼ˆå½“æ—¥åˆ†ã«åŠ ç®—ï¼‰
       â”‚
       â–¼
streaks ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  last_active_date ã¨ today ã®å·®   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·® = 0æ—¥ (åŒæ—¥)                  â”‚
â”‚   â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯å¤‰æ›´ãªã—            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·® = 1æ—¥ (é€£ç¶š)                  â”‚
â”‚   â†’ current_streak += 1          â”‚
â”‚   â†’ longest = max(current, longest)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·® = 2æ—¥ä»¥ä¸Š                      â”‚
â”‚   â†’ é–“ã®å…¨æ—¥ã‚’ç¢ºèªï¼ˆå¾Œè¿°ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
last_active_date = today ã«æ›´æ–°
```

**é–“ã®æ—¥ã‚’ç¢ºèªã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå·® â‰¥ 2æ—¥ï¼‰:**

```typescript
function checkGapDays(
  lastDate: string, today: string, freezes: string[]
): 'CONTINUE' | 'RESET' {
  const gap = daysBetween(lastDate, today);  // lastDate ã¨ today ã¯å«ã¾ãªã„
  const gapDates = getDatesBetween(lastDate, today); // é–“ã®æ—¥ä»˜ãƒªã‚¹ãƒˆ

  for (const date of gapDates) {
    const hasFreezeOnDate = freezes.includes(date);
    if (!hasFreezeOnDate) return 'RESET';
  }
  return 'CONTINUE';
}
```

### 5.3 ã‚ã¨ã‹ã‚‰è¨˜éŒ²æ™‚ã®é¡åŠã‚¹ãƒˆãƒªãƒ¼ã‚¯å†è¨ˆç®—

ã‚ã¨ã‹ã‚‰è¨˜éŒ²ã¯éå»ã®æ—¥ä»˜ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã€å·®åˆ†æ›´æ–°ã§ã¯ä¸ååˆ†ã€‚**ãƒ•ãƒ«å†è¨ˆç®—**ãŒå¿…è¦ã€‚

**ğŸ”„ v1.1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã¨æœ€é©åŒ–**

| æ‡¸å¿µ | åˆ†æ |
|---|---|
| å†è¨ˆç®—ã‚³ã‚¹ãƒˆ | `daily_reading_logs` + `streak_freezes` ã‚’èµ°æŸ»ã€‚æœ€å¤§ã§ã‚‚éå» 365 æ—¥åˆ† = 365 è¡Œã€‚SQLite ã¯ 1ms ä»¥ä¸‹ã§å–å¾—å¯èƒ½ |
| é »åº¦ | ã‚ã¨ã‹ã‚‰è¨˜éŒ²ã¯é€šå¸¸ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ã¨æ¯”ã¹ã¦ä½é »åº¦ï¼ˆ1 æ—¥ 1 å›æœªæº€ãŒæƒ³å®šï¼‰ |
| **çµè«–** | **ãƒ•ãƒ«å†è¨ˆç®—ã§å•é¡Œãªã—ã€‚** æœ€é©åŒ–ã¯ä¸è¦ |

```typescript
async function recalculateStreak(userId: string, timezone: string) {
  const today = getUserToday(timezone);

  // 1. éå» 1 å¹´åˆ†ã® daily_reading_logs ã‚’å–å¾—ï¼ˆæ—¥ä»˜é™é †ï¼‰
  const logs = await db.select({ logDate: dailyReadingLogs.logDate })
    .from(dailyReadingLogs)
    .where(
      and(
        eq(dailyReadingLogs.userId, userId),
        gte(dailyReadingLogs.logDate, subtractDays(today, 365)),
        gt(dailyReadingLogs.sessionCount, 0)  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ 1 ä»¶ä»¥ä¸Šã‚ã‚‹æ—¥
      )
    )
    .orderBy(desc(dailyReadingLogs.logDate));

  // 2. ãƒ•ãƒªãƒ¼ã‚ºæ—¥ã‚’å–å¾—
  const freezes = await db.select({ usedDate: streakFreezes.usedDate })
    .from(streakFreezes)
    .where(eq(streakFreezes.userId, userId));
  const freezeSet = new Set(freezes.map(f => f.usedDate));

  // 3. ãƒ­ã‚°æ—¥ + ãƒ•ãƒªãƒ¼ã‚ºæ—¥ã‚’ãƒãƒ¼ã‚¸ã—ã¦ã€Œã‚«ãƒãƒ¼ã•ã‚ŒãŸæ—¥ã€ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
  const logSet = new Set(logs.map(l => l.logDate));

  // 4. today ã‹ã‚‰é¡ã£ã¦é€£ç¶šæ—¥æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
  let streak = 0;
  let currentDate = today;

  while (true) {
    const hasLog = logSet.has(currentDate);
    const hasFreeze = freezeSet.has(currentDate);

    if (hasLog) {
      streak++;
      currentDate = subtractDays(currentDate, 1);
    } else if (hasFreeze) {
      // ãƒ•ãƒªãƒ¼ã‚ºæ—¥: ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ç¶­æŒï¼ˆåŠ ç®—ã—ãªã„ï¼‰
      currentDate = subtractDays(currentDate, 1);
    } else {
      break;  // é€”åˆ‡ã‚Œ
    }
  }

  // 5. æ›´æ–°
  const currentLongest = await getExistingLongestStreak(userId);
  await db.update(streaks)
    .set({
      currentStreak: streak,
      longestStreak: Math.max(streak, currentLongest),
      lastActiveDate: logs[0]?.logDate ?? null,
      updatedAt: new Date().toISOString(),
    })
    .where(eq(streaks.userId, userId));
}
```

### 5.4 ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `X-Timezone` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸
- ã‚µãƒ¼ãƒãƒ¼ã¯ UTC ã§ä¿å­˜ã—ã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯åˆ¤å®šæ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® TZ ã§ã€Œä»Šæ—¥ã€ã‚’ç®—å‡º
- `local_date` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ TZ ã§ã®æ—¥ä»˜ã‚’æ˜ç¤ºçš„ã«ä¿æŒ

```typescript
function getUserToday(timezone: string): string {
  return new Date().toLocaleDateString('sv-SE', { timeZone: timezone });
  // â†’ "2026-02-24" (ISOå½¢å¼)
}
```

---

## 6. èªè¨¼ãƒ»èªå¯è¨­è¨ˆ

### 6.1 èªè¨¼ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚â”€â”€â”€â–¶â”‚  Clerk  â”‚â”€â”€â”€â–¶â”‚  OAuth Provider  â”‚
â”‚          â”‚â—€â”€â”€â”€â”‚         â”‚â—€â”€â”€â”€â”‚ (Google / Apple)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â”‚  JWT (çŸ­å‘½)    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚  Authorization: Bearer <jwt>
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hono API Server â”‚
â”‚                  â”‚
â”‚  Clerk Middleware â”‚
â”‚  â†’ JWT æ¤œè¨¼       â”‚
â”‚  â†’ userId æŠ½å‡º    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Clerk Webhook

```typescript
// POST /webhooks/clerk
app.post('/webhooks/clerk', async (c) => {
  const payload = await verifyClerkWebhook(c);
  
  switch (payload.type) {
    case 'user.created':
      // â†’ users ãƒ†ãƒ¼ãƒ–ãƒ«ã« INSERT
      // â†’ reading_goals ã«åˆæœŸãƒ¬ã‚³ãƒ¼ãƒ‰ INSERT
      // â†’ streaks ã«åˆæœŸãƒ¬ã‚³ãƒ¼ãƒ‰ INSERT
      break;
    case 'user.updated':
      // â†’ users ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ UPDATE
      break;
    case 'user.deleted':
      // â†’ users ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ DELETE (CASCADE ã§é–¢é€£ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤)
      break;
  }
});
```

### 6.3 èªå¯ï¼ˆRow-Level Securityï¼‰

Turso/libSQL ã«ã¯ RLS ãŒãªã„ãŸã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§å®Ÿè£…ã€‚

```typescript
// å…¨ Repository ãƒ¡ã‚½ãƒƒãƒ‰ã« userId ã‚’å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
class SessionRepository {
  async findActive(userId: string) {
    return db.select()
      .from(readingSessions)
      .where(
        and(
          eq(readingSessions.userId, userId),
          eq(readingSessions.isActive, 1)
        )
      );
  }
}
```

---

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 7.1 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
{
  error: {
    code: string;
    message: string;
    details?: Array<{ field: string; message: string }>;
  }
}
```

### 7.2 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§

| HTTP | code | ç™ºç”Ÿæ¡ä»¶ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå‡¦ç† |
|---|---|---|---|
| 400 | `VALIDATION_ERROR` | å…¥åŠ›å€¤ä¸æ­£ | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º |
| 400 | `SESSION_ALREADY_ACTIVE` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡ | ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° |
| 400 | `SESSION_ALREADY_PAUSED` | ğŸ†• æ—¢ã«ä¸€æ™‚åœæ­¢ä¸­ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 400 | `SESSION_NOT_PAUSED` | ğŸ†• ä¸€æ™‚åœæ­¢ä¸­ã§ãªã„ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 400 | `SESSION_NOT_ACTIVE` | ğŸ†• ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé€²è¡Œä¸­ã§ãªã„ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 400 | `SESSION_TOO_SHORT` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ 1 åˆ†æœªæº€ | ç ´æ£„ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° |
| 400 | `FREEZE_LIMIT_REACHED` | ãƒ•ãƒªãƒ¼ã‚ºæœˆ 2 å›ä¸Šé™ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 400 | `FREEZE_NOT_NEEDED` | ğŸ†• å½“æ—¥ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¸ˆï¼ˆãƒ•ãƒªãƒ¼ã‚ºä¸è¦ï¼‰ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 400 | `MANUAL_LOG_DATE_RANGE` | ã‚ã¨ã‹ã‚‰è¨˜éŒ²ã®æ—¥ä»˜ãŒ 7 æ—¥è¶… | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| 401 | `UNAUTHORIZED` | JWT ç„¡åŠ¹ / æœŸé™åˆ‡ã‚Œ | ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§» |
| 404 | `NOT_FOUND` | ãƒªã‚½ãƒ¼ã‚¹æœªç™ºè¦‹ | å‰ç”»é¢ã«æˆ»ã™ |
| 409 | `BOOK_ALREADY_IN_SHELF` | æœ¬æ£šã«åŒä¸€æ›¸ç±ãŒæ—¢ã«ã‚ã‚‹ | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º |
| 409 | `DUPLICATE_BOOK_CANDIDATE` | ğŸ†• é¡ä¼¼æ›¸ç±ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ | é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º |
| 429 | `RATE_LIMITED` | ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é | Exponential Backoff |
| 500 | `INTERNAL_ERROR` | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ | æ±ç”¨ã‚¨ãƒ©ãƒ¼ç”»é¢ |

### 7.3 Hono ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° Middleware

```typescript
app.onError((err, c) => {
  if (err instanceof AppError) {
    return c.json({ error: err.toJSON() }, err.statusCode);
  }
  Sentry.captureException(err);
  return c.json({
    error: { code: 'INTERNAL_ERROR', message: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' }
  }, 500);
});
```

---

## 8. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ»åŒæœŸè¨­è¨ˆ

### 8.1 æ–¹é‡

MVP ã§ã¯ãƒ¢ãƒã‚¤ãƒ«ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã‚’æœ€å°é™ã§å®Ÿè£…ã€‚ã€Œèª­æ›¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ã ã‘ã¯çµ¶å¯¾ã«å¤±ã‚ã‚Œãªã„ã€ã‚’ä¿è¨¼ã€‚

### 8.2 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒãƒˆãƒªã‚¯ã‚¹

| æ“ä½œ | ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‹•ä½œ | åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|---|---|---|
| ç”»é¢è¡¨ç¤ºï¼ˆREADï¼‰ | Embedded Replica ã‹ã‚‰èª­ã¿å–ã‚Š | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®šæœŸ sync |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ | ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹å§‹ | â€” |
| ä¸€æ™‚åœæ­¢/å†é–‹ | ğŸ†• ãƒ­ãƒ¼ã‚«ãƒ«ã« `session_pauses` ã‚’è¨˜éŒ² | sync æ™‚ã«ãƒãƒƒãƒé€ä¿¡ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† | ãƒ­ãƒ¼ã‚«ãƒ« DB ã«ä¿å­˜ | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã« sync |
| ã‚ã¨ã‹ã‚‰è¨˜éŒ² | ãƒ­ãƒ¼ã‚«ãƒ« DB ã«ä¿å­˜ | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã« sync |
| æ›¸ç±è¿½åŠ ï¼ˆæ¤œç´¢ï¼‰ | ä¸å¯ï¼ˆå¤–éƒ¨ API å¿…è¦ï¼‰ | â€” |
| æ›¸ç±è¿½åŠ ï¼ˆæ‰‹å‹•ï¼‰ | ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã« sync |
| çµ±è¨ˆè¡¨ç¤º | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤º | â€” |

### 8.3 åŒæœŸãƒ•ãƒ­ãƒ¼

```
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ¤œçŸ¥
       â”‚
       â–¼
synced_at IS NULL ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
       â”‚
       â–¼
API ã¸é€ä¿¡ï¼ˆãƒãƒƒãƒï¼‰
       â”‚
       â”œâ”€â”€ æˆåŠŸ â†’ synced_at ã‚’æ›´æ–°
       â”‚
       â””â”€â”€ å¤±æ•— â†’ ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
              â”‚
              â–¼
         Exponential Backoff ã§å†è©¦è¡Œï¼ˆæœ€å¤§ 5 å›ï¼‰
```

### 8.4 ç«¶åˆè§£æ±º

```
Last-Write-Winsï¼ˆupdated_at ãƒ™ãƒ¼ã‚¹ï¼‰
  â†’ MVP ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒ‡ãƒã‚¤ã‚¹æƒ³å®š
  â†’ ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œæ™‚ã¯ CRDT ã‚’æ¤œè¨ï¼ˆPhase 2 ä»¥é™ï¼‰
```

---

## 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 9.1 é€šä¿¡

| é …ç›® | å®Ÿè£… |
|---|---|
| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | HTTPS (TLS 1.3)ã€‚Cloudflare ãŒçµ‚ç«¯ |
| HSTS | `Strict-Transport-Security: max-age=31536000; includeSubDomains` |
| CORS | `api.bookloop.app` ã¯ Web ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ã®ã¿è¨±å¯ |

### 9.2 èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

| ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ä¿å­˜å…ˆ |
|---|---|
| Web | HttpOnly Cookieï¼ˆClerk ãŒç®¡ç†ï¼‰ |
| Mobile | Expo SecureStore |

### 9.3 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

Cloudflare Workers ã® KV ã‚’åˆ©ç”¨ã—ãŸ Sliding Window æ–¹å¼ã€‚

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | åˆ¶é™ |
|---|---|
| `POST /webhooks/*` | Svix ç½²åæ¤œè¨¼ã®ã¿ |
| `GET /books/search` | 30 req/min/user |
| `POST /sessions/*` | 10 req/min/user |
| ãã®ä»– GET | 100 req/min/user |
| ãã®ä»– POST/PATCH/DELETE | 30 req/min/user |

### 9.4 å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£/ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ Zod ã‚¹ã‚­ãƒ¼ãƒã§æ¤œè¨¼ã€‚

```typescript
const createSessionSchema = z.object({
  bookId: z.string().min(1),
  sessionType: z.enum(['TIMER', 'EXTERNAL']),
  externalApp: z.enum(['KINDLE', 'KOBO', 'OTHER']).optional(),
}).refine(
  (data) => data.sessionType !== 'EXTERNAL' || data.externalApp != null,
  { message: 'å¤–éƒ¨ã‚¢ãƒ—ãƒªèª­æ›¸æ™‚ã¯ externalApp ã‚’æŒ‡å®šã—ã¦ãã ã•ã„' }
);
```

---

## 10. å¤–éƒ¨ API é€£æº

### 10.1 æ›¸ç±æ¤œç´¢ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

```
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: GET /books/search?q=xxx&type=keyword
       â”‚
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¤œç´¢ â”‚â”€â”€â”€â”€ ãƒ’ãƒƒãƒˆ â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ãƒŸã‚¹
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Google Books API â”‚â”€â”€â”€â”€ æˆåŠŸ â†’ DB ã« UPSERT â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å¤±æ•— or çµæœ 0 ä»¶
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    OpenBD API   â”‚â”€â”€â”€â”€ æˆåŠŸ â†’ DB ã« UPSERT â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ å¤±æ•—
           â–¼
   ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

### 10.2 æ›¸ç±ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥

- æ¤œç´¢çµæœã®æ›¸ç±ã¯ `books` ãƒ†ãƒ¼ãƒ–ãƒ«ã«è‡ªå‹• UPSERTï¼ˆISBN ãƒ™ãƒ¼ã‚¹ï¼‰
- åŒä¸€ ISBN ã§ã®å†æ¤œç´¢ã¯ DB ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å„ªå…ˆ
- æ›¸å½± URL ã¯å¤–éƒ¨ CDN ã‚’ç›´æ¥å‚ç…§ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚³ãƒ”ãƒ¼ã—ãªã„ï¼‰

---

## 11. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

### 11.1 Monorepo æ§‹æˆ

```
bookloop/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                    # Hono on Cloudflare Workers
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â””â”€â”€ db/
â”‚   â”‚   â”‚       â”œâ”€â”€ schema.ts
â”‚   â”‚   â”‚       â””â”€â”€ migrations/
â”‚   â”‚   â”œâ”€â”€ wrangler.toml
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ mobile/                 # React Native (Expo)
â”‚   â”‚   â”œâ”€â”€ app/                # Expo Router
â”‚   â”‚   â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ (tabs)/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx        # ãƒ›ãƒ¼ãƒ  (S-04)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bookshelf.tsx    # æœ¬æ£š (S-05)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ stats.tsx        # çµ±è¨ˆ (S-10)
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ profile.tsx      # è¨­å®š (S-11)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ book/[id].tsx        # æ›¸ç±è©³ç´° (S-07)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ start.tsx        # ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ (S-08a)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ timer.tsx        # ã‚¿ã‚¤ãƒãƒ¼ (S-08)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ external.tsx     # å¤–éƒ¨ã‚¢ãƒ—ãƒª (S-08b)
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ complete.tsx     # ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† (S-09)
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ manual.tsx       # ã‚ã¨ã‹ã‚‰è¨˜éŒ² (S-08c)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ search.tsx           # æ›¸ç±æ¤œç´¢ (S-06)
â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding.tsx
â”‚   â”‚   â”‚   â””â”€â”€ sign-in.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ stores/             # Zustand ã‚¹ãƒˆã‚¢
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ web/                    # Next.js (App Router)
â”‚       â”œâ”€â”€ app/
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/                 # ğŸ”„ v1.1: å…±æœ‰å†…å®¹ã‚’æ˜ç¢ºåŒ–
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ types/          # å‹å®šç¾©ï¼ˆå¾Œè¿°ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ validators/     # Zod ã‚¹ã‚­ãƒ¼ãƒï¼ˆå¾Œè¿°ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ constants/      # å®šæ•°ï¼ˆå¾Œè¿°ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ utils/          # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå¾Œè¿°ï¼‰
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â””â”€â”€ ui/                     # å…±æœ‰ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆå°†æ¥ï¼‰
â”‚
â”œâ”€â”€ turbo.json
â”œâ”€â”€ package.json
â””â”€â”€ pnpm-workspace.yaml
```

### 11.2 `packages/shared` ã®å†…å®¹å®šç¾©ï¼ˆğŸ†• v1.1 è¿½åŠ ï¼‰

v1.0 ã§ã¯ã€Œå…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ã€ã®å®šç¾©ãŒæ›–æ˜§ã ã£ãŸã€‚ä½•ã‚’å…±æœ‰ã—ã€ä½•ã‚’å…±æœ‰ã—ãªã„ã‹ã‚’æ˜ç¢ºåŒ–ã™ã‚‹ã€‚

#### å…±æœ‰ã™ã‚‹ã‚‚ã®

| ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | å†…å®¹ | åˆ©ç”¨å´ |
|---|---|---|
| `types/` | API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹å®šç¾©ã€DB ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å‹ | api, mobile, web |
| `validators/` | Zod ã‚¹ã‚­ãƒ¼ãƒï¼ˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ | apiï¼ˆã‚µãƒ¼ãƒãƒ¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰, mobile/webï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ |
| `constants/` | å®šæ•°å€¤ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ—æŒ™ã€ã‚¸ãƒ£ãƒ³ãƒ«åˆ—æŒ™ã€åˆ¶é™å€¤ç­‰ï¼‰ | api, mobile, web |
| `utils/` | ç´”ç²‹ãªè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¥ä»˜è¨ˆç®—ã€ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›ç­‰ï¼‰ | api, mobile, web |

#### å…±æœ‰ã—ãªã„ã‚‚ã®

| å†…å®¹ | ç†ç”± | é…ç½®å…ˆ |
|---|---|---|
| DB ã‚¹ã‚­ãƒ¼ãƒ (Drizzle) | API å°‚ç”¨ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã« DB å±¤ã‚’éœ²å‡ºã•ã›ãªã„ | `apps/api/src/db/` |
| UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | React Native ã¨ Next.js ã§å…±é€šåŒ–ã™ã‚‹ã«ã¯æ™‚æœŸå°šæ—©ï¼ˆMVP å¾Œã«æ¤œè¨ï¼‰ | å„ `apps/` å†… |
| API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | Hono RPC (`hc`) ã§è‡ªå‹•ç”Ÿæˆã€‚å…±æœ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ç½®ãå¿…è¦ãªã— | å„ `apps/` å†… |
| ç’°å¢ƒå¤‰æ•° / ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ | ç’°å¢ƒä¾å­˜ | å„ `apps/` ã® `.env` |

#### å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ä¾‹

```typescript
// packages/shared/src/types/session.ts
export type SessionType = 'TIMER' | 'EXTERNAL' | 'MANUAL';
export type ExternalApp = 'KINDLE' | 'KOBO' | 'OTHER';

export interface Session {
  id: string;
  bookId: string;
  sessionType: SessionType;
  externalApp: ExternalApp | null;
  startedAt: string;
  endedAt: string | null;
  durationSec: number;
  pausedTotalSec: number;
  pageStart: number | null;
  pageEnd: number | null;
  memo: string | null;
  isActive: boolean;
  isPaused: boolean;
  localDate: string;
}

// packages/shared/src/validators/session.ts
export const createSessionSchema = z.object({
  bookId: z.string().min(1),
  sessionType: z.enum(['TIMER', 'EXTERNAL']),
  externalApp: z.enum(['KINDLE', 'KOBO', 'OTHER']).optional(),
}).refine(
  (data) => data.sessionType !== 'EXTERNAL' || data.externalApp != null,
  { message: 'å¤–éƒ¨ã‚¢ãƒ—ãƒªèª­æ›¸æ™‚ã¯ externalApp ã‚’æŒ‡å®šã—ã¦ãã ã•ã„' }
);

// packages/shared/src/constants/index.ts
export const STREAK_FREEZE_MAX_PER_MONTH = 2;
export const MANUAL_LOG_MAX_DAYS_AGO = 7;
export const SESSION_MIN_DURATION_SEC = 60;
export const SESSION_AUTO_END_HOURS = 24;
export const BOOKSHELF_PAGE_SIZE_DEFAULT = 20;
export const BOOKSHELF_PAGE_SIZE_MAX = 50;

// packages/shared/src/utils/date.ts
export function getUserToday(timezone: string): string {
  return new Date().toLocaleDateString('sv-SE', { timeZone: timezone });
}

export function daysBetween(dateA: string, dateB: string): number {
  const a = new Date(dateA);
  const b = new Date(dateB);
  return Math.floor(Math.abs(b.getTime() - a.getTime()) / 86400000);
}

export function subtractDays(date: string, days: number): string {
  const d = new Date(date);
  d.setDate(d.getDate() - days);
  return d.toISOString().split('T')[0];
}
```

---

## 12. Embedded Replica åŒæœŸè¨­è¨ˆï¼ˆğŸ†• v1.1 è¿½åŠ ï¼‰

### 12.1 Turso Embedded Replica ã®ä»•çµ„ã¿

Turso ã® Embedded Replica ã¯ã€Primary DB ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç«¯æœ«ã®ãƒ­ãƒ¼ã‚«ãƒ« SQLite ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ä»•çµ„ã¿ã€‚èª­ã¿å–ã‚Šã¯ãƒ­ãƒ¼ã‚«ãƒ«ã€æ›¸ãè¾¼ã¿ã¯ Primary ã¸è»¢é€ã•ã‚Œã‚‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      sync       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile App â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  Turso Primary   â”‚
â”‚             â”‚                  â”‚  (Cloudflare)    â”‚
â”‚  Embedded   â”‚  READ: ãƒ­ãƒ¼ã‚«ãƒ«   â”‚                  â”‚
â”‚  Replica    â”‚  WRITE: Primary  â”‚                  â”‚
â”‚  (SQLite)   â”‚  ã¸è»¢é€          â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°æˆ¦ç•¥

| ã‚¿ã‚¤ãƒŸãƒ³ã‚° | ãƒˆãƒªã‚¬ãƒ¼ | ç›®çš„ |
|---|---|---|
| **ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚** | `AppState` = active | æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å¾Œ** | API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æ™‚ | ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»çµ±è¨ˆã®å³æ™‚åæ˜  |
| **ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚** | `AppState` change | ä»–ãƒ‡ãƒã‚¤ã‚¹ã®å¤‰æ›´ã‚’åæ˜ ï¼ˆå°†æ¥ï¼‰ |
| **å®šæœŸ sync** | 5 åˆ†é–“éš”ï¼ˆã‚¢ãƒ—ãƒªãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–“ï¼‰ | ä¸€å®šã®é®®åº¦ã‚’ä¿ã¤ |
| **æ‰‹å‹• Pull-to-Refresh** | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ | æ˜ç¤ºçš„ãªæœ€æ–°åŒ– |

### 12.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¸ã®å½±éŸ¿

| ã‚·ãƒŠãƒªã‚ª | ä½“é¨“ |
|---|---|
| ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† â†’ ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ | API å®Œäº†å¾Œã« sync â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯æ•°ãŒå³åº§ã«æ›´æ–°ã•ã‚Œã‚‹ |
| ã‚¢ãƒ—ãƒªã‚’æ•°æ™‚é–“ã¶ã‚Šã«é–‹ã | èµ·å‹•æ™‚ sync â†’ 0.5ã€œ1 ç§’ã§æœ€æ–°çŠ¶æ…‹ã« |
| å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§èª­æ›¸ | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã€‚å¾©å¸°æ™‚ã« sync |

### 12.4 Web ã®å ´åˆ

Web (Next.js) ã¯ Embedded Replica ã‚’ä½¿ç”¨ã—ãªã„ã€‚ç›´æ¥ API ã‚’å©ãã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ React State / SWR ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ç®¡ç†ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã¯ MVP ã§ã¯ Web éå¯¾å¿œã€‚

---

## 13. ãƒ†ã‚¹ãƒˆæ–¹é‡

### 13.1 ãƒ†ã‚¹ãƒˆãƒ¬ãƒ™ãƒ«

| ãƒ¬ãƒ™ãƒ« | ãƒ„ãƒ¼ãƒ« | å¯¾è±¡ | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ |
|---|---|---|---|
| ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ | Vitest | Services / ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®— / ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ / ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ | 80%+ |
| çµåˆãƒ†ã‚¹ãƒˆ | Vitest + Miniflare | API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â†’ DB | ä¸»è¦ãƒ•ãƒ­ãƒ¼ 100% |
| E2E ãƒ†ã‚¹ãƒˆ | Maestro (Mobile) | ä¸»è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ | 5 ã‚·ãƒŠãƒªã‚ª |

### 13.2 é‡ç‚¹ãƒ†ã‚¹ãƒˆé …ç›®

| # | ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ãƒ†ã‚¹ãƒˆå†…å®¹ |
|---|---|---|
| T1 | ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®— | é€£ç¶šæ—¥ã€é€”åˆ‡ã‚Œã€ãƒ•ãƒªãƒ¼ã‚ºæŒŸã¿ã€TZ å¢ƒç•Œã€ã‚ã¨ã‹ã‚‰è¨˜éŒ²ã®é¡åŠ |
| T2 | ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡ | é‡è¤‡é˜²æ­¢ã€ä¸€æ™‚åœæ­¢/å†é–‹ã€1 åˆ†æœªæº€ã®ç ´æ£„ã€24h è‡ªå‹•çµ‚äº†ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³â†’åŒæœŸ |
| T3 | èªå¯ | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ |
| T4 | ã‚ã¨ã‹ã‚‰è¨˜éŒ² | æ—¥ä»˜ç¯„å›²ãƒã‚§ãƒƒã‚¯ã€daily_reading_logs å†é›†è¨ˆã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯é¡åŠå†è¨ˆç®— |
| T5 | ğŸ†• ä¸€æ™‚åœæ­¢ | åœæ­¢ä¸­ã«çµ‚äº†ã€è¤‡æ•°å›åœæ­¢/å†é–‹ã€duration_sec ã®æ•´åˆæ€§ |

### 13.3 E2E ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

| # | ã‚·ãƒŠãƒªã‚ª | ã‚¹ãƒ†ãƒƒãƒ— |
|---|---|---|
| E1 | æ–°è¦ç™»éŒ²ã€œåˆå›èª­æ›¸ | ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— â†’ ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚° â†’ æ›¸ç±è¿½åŠ  â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† |
| E2 | å¤–éƒ¨ã‚¢ãƒ—ãƒªèª­æ›¸ | ãƒ›ãƒ¼ãƒ  â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ â†’ Kindle é¸æŠ â†’ çµ‚äº† â†’ å®Œäº† |
| E3 | ã‚ã¨ã‹ã‚‰è¨˜éŒ² | ãƒ›ãƒ¼ãƒ  â†’ ã‚ã¨ã‹ã‚‰è¨˜éŒ² â†’ å…¥åŠ› â†’ ä¿å­˜ â†’ ã‚¹ãƒˆãƒªãƒ¼ã‚¯åæ˜ ç¢ºèª |
| E4 | ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ•ãƒªãƒ¼ã‚º | è¨­å®š â†’ ãƒ•ãƒªãƒ¼ã‚ºç™ºå‹• â†’ ç¿Œæ—¥ã‚¹ãƒˆãƒªãƒ¼ã‚¯ç¶­æŒç¢ºèª |
| E5 | æœ¬æ£šæ“ä½œ | æ›¸ç±æ¤œç´¢ â†’ è¿½åŠ  â†’ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ â†’ å‰Šé™¤ |

---

## 14. ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»CI/CD

### 14.1 ç’°å¢ƒæ§‹æˆ

| ç’°å¢ƒ | API | Web | Mobile | DB |
|---|---|---|---|---|
| **Development** | `wrangler dev` | `next dev` | Expo Dev Client | Turso ãƒ­ãƒ¼ã‚«ãƒ« |
| **Staging** | Workers (staging) | Vercel Preview | EAS Internal | Turso staging DB |
| **Production** | Workers (production) | Vercel Production | App Store / Play Store | Turso production DB |

### 14.2 CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
Push to main
     â”‚
     â”œâ”€â”€ API: Wrangler deploy â†’ Cloudflare Workers
     â”œâ”€â”€ Web: Vercel è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
     â””â”€â”€ Mobile: EAS Build â†’ TestFlight / Internal Testing

Push to feature/*
     â”‚
     â”œâ”€â”€ Lint + Type Check (Turborepo)
     â”œâ”€â”€ Unit / Integration Tests (Vitest)
     â””â”€â”€ Web: Vercel Preview ãƒ‡ãƒ—ãƒ­ã‚¤
```

### 14.3 ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

| å¯¾è±¡ | ãƒ„ãƒ¼ãƒ« | ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ |
|---|---|---|
| ã‚¨ãƒ©ãƒ¼ | Sentry | æ–°è¦ã‚¨ãƒ©ãƒ¼ / ã‚¨ãƒ©ãƒ¼ç‡æ€¥å¢— |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | Cloudflare Analytics | p95 > 500ms |
| ç¨¼åƒç‡ | Cloudflare Health Check | ãƒ€ã‚¦ãƒ³æ¤œçŸ¥ |
| DB | Turso Dashboard | å®¹é‡ 80% è¶…é |

---

## ä»˜éŒ² A: æŠ€è¡“çš„æ±ºå®šè¨˜éŒ² (ADR)

### ADR-001: DB ã‚’ Supabase ã‹ã‚‰ Turso ã«å¤‰æ›´

- **æ±ºå®š:** Turso + Embedded Replica ã‚’æ¡ç”¨
- **ç†ç”±:** SQLite äº’æ›ã® Embedded Replica ã§ãƒ¢ãƒã‚¤ãƒ«ã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³èª­ã¿å–ã‚Šã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–å®Ÿè£…å¯èƒ½
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** PostgreSQL å›ºæœ‰æ©Ÿèƒ½ï¼ˆJSONBã€é…åˆ—å‹ã€RLSï¼‰ãŒä½¿ãˆãªã„

### ADR-002: èªè¨¼ã‚’ Supabase Auth ã‹ã‚‰ Clerk ã«å¤‰æ›´

- **æ±ºå®š:** Clerk ã‚’æ¡ç”¨
- **ç†ç”±:** Expo SDK å…¬å¼å¯¾å¿œã€‚Google/Apple OAuth çµ„ã¿è¾¼ã¿æ¸ˆã¿ã€‚Webhook ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸãŒå®¹æ˜“
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ç„¡æ–™æ  10,000 MAU

### ADR-003: API ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã« Hono ã‚’æ¡ç”¨

- **æ±ºå®š:** Hono on Cloudflare Workers
- **ç†ç”±:** ã‚¨ãƒƒã‚¸å®Ÿè¡Œã§ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€‚Hono RPC ã§å‹å®‰å…¨ã€‚ãƒ¢ãƒã‚¤ãƒ«ã¨ Web ã§åŒä¸€ API ã‚’åˆ©ç”¨
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ã‚¤ãƒ³ãƒ•ãƒ©ãŒ Cloudflare + Vercel ã® 2 ç³»çµ±

### ADR-004: ä¸€æ™‚åœæ­¢ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ï¼ˆğŸ†• v1.1ï¼‰

- **æ±ºå®š:** ä¸€æ™‚åœæ­¢/å†é–‹ã‚’ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æä¾›ã—ã€`session_pauses` ãƒ†ãƒ¼ãƒ–ãƒ«ã§è¨˜éŒ²
- **ç†ç”±:** `duration_sec` ã®ç®—å‡ºæ ¹æ‹ ã‚’æ˜ç¢ºã«ã™ã‚‹ã€‚æ¤œç®—å¯èƒ½ã«ã™ã‚‹
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã«ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ä¸€æ™‚åœæ­¢ã‚’è¨˜éŒ²ã—ã€sync æ™‚ã«ãƒãƒƒãƒé€ä¿¡ã™ã‚‹è¿½åŠ å®Ÿè£…ãŒå¿…è¦

### ADR-005: æœ¬æ£šè¿½åŠ ãƒ•ãƒ­ãƒ¼ã®åˆ†é›¢ï¼ˆğŸ†• v1.1ï¼‰

- **æ±ºå®š:** `POST /bookshelf` ã¯ `bookId` ã‚’å—ã‘å–ã‚‹ã ã‘ã«ã—ã€æ›¸ç±ã®æ¤œç´¢/ä½œæˆã¯åˆ¥ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å‡¦ç†
- **ç†ç”±:** 1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è²¬å‹™ãŒå¤§ãã™ããŸã€‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒè¤‡é›‘ã«ãªã‚‹
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ•ãƒ­ãƒ¼ãŒ 2 ã‚¹ãƒ†ãƒƒãƒ—ã«ãªã‚‹ï¼ˆæ¤œç´¢ â†’ è¿½åŠ ï¼‰

### ADR-006: ãƒ•ãƒªãƒ¼ã‚ºç™ºå‹•ã‚’å½“æ—¥é™å®šã«ï¼ˆğŸ†• v1.1ï¼‰

- **æ±ºå®š:** ãƒ•ãƒªãƒ¼ã‚ºã¯å½“æ—¥ã®ã¿ç™ºå‹•å¯èƒ½ã€‚äº‹å‰äºˆç´„ã¯ä¸å¯
- **ç†ç”±:** äº‹å‰äºˆç´„ã‚’è¨±å¯ã™ã‚‹ã¨ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¨ˆç®—ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒå¢—å¤§ã™ã‚‹
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:** ã€Œæ˜æ—¥ä¼‘ã‚€äºˆå®šã ã‹ã‚‰ãƒ•ãƒªãƒ¼ã‚ºã‚’äº‹å‰ã«ä½¿ã„ãŸã„ã€ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«éå¯¾å¿œã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å½“æ—¥ä¸­ã«å¿˜ã‚Œãšç™ºå‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

---

## ä»˜éŒ² B: v1.0 â†’ v1.1 å¤‰æ›´ã‚µãƒãƒªãƒ¼

| # | å•é¡Œ | ä¿®æ­£å†…å®¹ |
|---|---|---|
| 1 | æ‰‹å‹•ç™»éŒ²æ›¸ç±ã®é‡è¤‡åˆ¶å¾¡ãŒæœªå®šç¾© | ã‚¢ãƒ—ãƒªå±¤ã§ã®é¡ä¼¼æ›¸ç±ãƒã‚§ãƒƒã‚¯ + `DUPLICATE_BOOK_CANDIDATE` ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿½åŠ  |
| 2 | ä¸€æ™‚åœæ­¢ã¨ duration_sec ã®çŸ›ç›¾ | `session_pauses` ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã€‚`paused_total_sec`, `is_paused` ã‚«ãƒ©ãƒ è¿½åŠ ã€‚pause/resume API è¿½åŠ  |
| 3 | daily_reading_logs ã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ›–æ˜§ | é€šå¸¸ã‚»ãƒƒã‚·ãƒ§ãƒ³=åŠ ç®— UPSERTã€ã‚ã¨ã‹ã‚‰è¨˜éŒ²=å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å†é›†è¨ˆã®ãƒ«ãƒ¼ãƒ«ã‚’æ˜ç¢ºåŒ– |
| 4 | ä¸€æ™‚åœæ­¢ã® API ãŒæœªå®šç¾© | `POST /sessions/:id/pause` ã¨ `POST /sessions/:id/resume` ã‚’è¿½åŠ  |
| 5 | POST /bookshelf ã®è²¬å‹™éå¤§ | æ›¸ç±æ¤œç´¢/ä½œæˆã¨æœ¬æ£šè¿½åŠ ã‚’åˆ†é›¢ã€‚`/books/search` å†…ã§ DB è‡ªå‹• UPSERT |
| 6 | ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã®ãƒ•ãƒ­ãƒ¼æœªè¨­è¨ˆ | ãƒ‘ã‚¿ãƒ¼ãƒ³ A/B/C ã¨ã—ã¦æ˜ç¢ºåŒ–ï¼ˆæ¤œç´¢çµæœã‹ã‚‰è¿½åŠ ã€ã‚¹ã‚­ãƒ£ãƒ³ã€æ‰‹å‹•ï¼‰ |
| 7 | ãƒ•ãƒªãƒ¼ã‚ºã€Œäº‹å‰ç™ºå‹•ã€ã®å®šç¾©ãŒæ›–æ˜§ | å½“æ—¥é™å®šã«æ±ºå®šã€‚ãƒ«ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ  |
| 8 | ã‚¹ãƒˆãƒªãƒ¼ã‚¯é¡åŠå†è¨ˆç®—ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ‡¸å¿µ | åˆ†æã®çµæœã€æœ€å¤§ 365 è¡Œã®èµ°æŸ»ã§å•é¡Œãªã—ã€‚ãƒ•ãƒ«å†è¨ˆç®—ã§ç¢ºå®š |
| 9 | packages/shared ã®å†…å®¹ãŒæœªå®šç¾© | å…±æœ‰ã™ã‚‹/ã—ãªã„ã‚‚ã®ã‚’æ˜ç¢ºåŒ–ã€‚å…·ä½“çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ä¾‹ã‚’è¿½åŠ  |
| 10 | Embedded Replica ã®åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°æœªæ¤œè¨ | ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 12 ã‚’æ–°è¨­ã€‚5 ã¤ã®åŒæœŸã‚¿ã‚¤ãƒŸãƒ³ã‚°æˆ¦ç•¥ã‚’å®šç¾© |
