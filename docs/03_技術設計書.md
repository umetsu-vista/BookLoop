# BookLoop — 技術設計書 v1.0

> **最終更新:** 2026-02-24
> **ステータス:** ドラフト
> **対象スコープ:** MVP（Phase 1）

---

## 1. アーキテクチャ概要

```
┌─────────────────────────────────────────────────────┐
│                    Client Layer                      │
│  ┌───────────────┐  ┌───────────────┐               │
│  │  React Native │  │  React Native │               │
│  │  (iOS/Android)│  │   (Web/Expo)  │               │
│  └───────┬───────┘  └───────┬───────┘               │
│          │    Expo Router    │                        │
│          └────────┬─────────┘                        │
│                   │                                  │
│          ┌────────┴────────┐                         │
│          │  libSQL Client  │  ← Embedded Replica     │
│          │  (ローカルDB)    │    (オフライン対応)      │
│          └────────┬────────┘                         │
└───────────────────┼─────────────────────────────────┘
                    │ Sync
┌───────────────────┼─────────────────────────────────┐
│               Server Layer                           │
│                   │                                  │
│          ┌────────┴────────┐                         │
│          │   Hono (API)    │  ← Cloudflare Workers   │
│          └──┬──────────┬───┘                         │
│             │          │                             │
│    ┌────────┴───┐  ┌───┴──────────┐                  │
│    │   Turso    │  │  Cloudflare  │                  │
│    │  (Primary) │  │  R2 (画像)   │                  │
│    └────────────┘  └──────────────┘                  │
│                                                      │
│    ┌────────────┐  ┌──────────────┐                  │
│    │   Clerk    │  │ Google Books │                  │
│    │   (認証)   │  │  API (書籍)  │                  │
│    └────────────┘  └──────────────┘                  │
└─────────────────────────────────────────────────────┘
```

### 1.1 技術スタック

| レイヤー | 技術 | 選定理由 |
|---|---|---|
| **フロントエンド** | React Native (Expo SDK 52+) | iOS/Android/Web を単一コードベースで |
| **ルーティング** | Expo Router v4 | ファイルベース、Web 対応 |
| **状態管理** | Zustand + TanStack Query | 軽量＆サーバー状態の自動キャッシュ |
| **API サーバー** | Hono on Cloudflare Workers | エッジ実行、コールドスタートなし、無料枠大 |
| **データベース** | Turso (libSQL) | SQLite 互換、Embedded Replica でオフライン対応 |
| **認証** | Clerk | ソーシャルログイン（Google/Apple）即対応 |
| **画像ストレージ** | Cloudflare R2 | S3 互換、エグレス無料 |
| **書籍データ** | Google Books API + openBD | 書籍メタデータ・書影の取得 |
| **プッシュ通知** | Expo Notifications | リマインド・ストリーク警告 |
| **分析** | PostHog (self-host or cloud) | プライバシー配慮＆無料枠あり |

### 1.2 Turso + Embedded Replica 戦略

Turso の Embedded Replica を活用し、**ローカル SQLite にデータを保持**する。

- **READ**: ローカル Replica から即座に返す（オフライン対応）
- **WRITE**: Turso Primary に書き込み → ローカルに自動 Sync
- **競合解決**: Last-Write-Wins（タイムスタンプベース）。MVP ではシングルユーザーなので複雑な CRDT は不要
- **Sync タイミング**: アプリフォアグラウンド復帰時 + 手動プルダウン

---

## 2. データベース設計

### 2.1 ER 図

```
users ──────< books ──────< reading_sessions
  │              │                  │
  │              │──────< bookmarks │
  │              │                  │
  │              │──────< notes     │
  │                                 │
  └──────< streak_freezes           │
  │                                 │
  └──────< user_goals               │
  │                                 │
  └──────< reading_stats_daily ─────┘
```

### 2.2 テーブル定義

```sql
-- ============================================
-- ユーザー
-- ============================================
CREATE TABLE users (
  id            TEXT PRIMARY KEY,          -- Clerk user_id
  display_name  TEXT NOT NULL,
  email         TEXT NOT NULL UNIQUE,
  avatar_url    TEXT,
  timezone      TEXT NOT NULL DEFAULT 'Asia/Tokyo',
  created_at    TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

-- ============================================
-- 書籍マスタ
-- ============================================
CREATE TABLE books (
  id            TEXT PRIMARY KEY,          -- ULID
  user_id       TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title         TEXT NOT NULL,
  author        TEXT,
  publisher     TEXT,
  isbn          TEXT,
  total_pages   INTEGER,
  cover_url     TEXT,
  genre         TEXT,                      -- 'business' | 'literature' | 'self_help' | ...
  status        TEXT NOT NULL DEFAULT 'want_to_read',
                                          -- 'want_to_read' | 'reading' | 'finished'
  current_page  INTEGER NOT NULL DEFAULT 0,
  source        TEXT,                      -- 'google_books' | 'openbd' | 'manual'
  external_id   TEXT,                      -- Google Books volume ID
  started_at    TEXT,
  finished_at   TEXT,
  created_at    TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_books_user_status ON books(user_id, status);
CREATE INDEX idx_books_isbn ON books(isbn);

-- ============================================
-- 読書セッション
-- ============================================
CREATE TABLE reading_sessions (
  id             TEXT PRIMARY KEY,         -- ULID
  user_id        TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  book_id        TEXT NOT NULL REFERENCES books(id) ON DELETE CASCADE,
  started_at     TEXT NOT NULL,            -- セッション開始時刻
  ended_at       TEXT,                     -- セッション終了時刻
  duration_sec   INTEGER NOT NULL DEFAULT 0,
  start_page     INTEGER,
  end_page       INTEGER,
  pages_read     INTEGER,
  reading_method TEXT NOT NULL DEFAULT 'in_app',
                                          -- 'in_app' | 'kindle' | 'kobo' | 'apple_books' | 'paper' | 'other'
  is_manual      INTEGER NOT NULL DEFAULT 0,  -- あとから記録フラグ
  session_date   TEXT NOT NULL,            -- 記録対象の日付 (YYYY-MM-DD、ユーザーTZ)
  status         TEXT NOT NULL DEFAULT 'active',
                                          -- 'active' | 'paused' | 'completed'
  created_at     TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at     TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_sessions_user_date ON reading_sessions(user_id, session_date);
CREATE INDEX idx_sessions_book ON reading_sessions(book_id);

-- ============================================
-- メモ
-- ============================================
CREATE TABLE notes (
  id            TEXT PRIMARY KEY,          -- ULID
  user_id       TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  book_id       TEXT NOT NULL REFERENCES books(id) ON DELETE CASCADE,
  session_id    TEXT REFERENCES reading_sessions(id) ON DELETE SET NULL,
  content       TEXT NOT NULL,
  page_number   INTEGER,
  created_at    TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at    TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_notes_book ON notes(book_id);

-- ============================================
-- 読書目標
-- ============================================
CREATE TABLE user_goals (
  id               TEXT PRIMARY KEY,       -- ULID
  user_id          TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  days_per_week    INTEGER NOT NULL DEFAULT 5,
  books_per_month  INTEGER NOT NULL DEFAULT 2,
  min_minutes_per_session INTEGER NOT NULL DEFAULT 1,
  effective_from   TEXT NOT NULL,           -- 有効開始日
  created_at       TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_goals_user ON user_goals(user_id, effective_from);

-- ============================================
-- ストリーク管理
-- ============================================
CREATE TABLE streaks (
  id              TEXT PRIMARY KEY,        -- ULID
  user_id         TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  current_count   INTEGER NOT NULL DEFAULT 0,
  longest_count   INTEGER NOT NULL DEFAULT 0,
  last_active_date TEXT,                   -- 最後に読書した日 (YYYY-MM-DD)
  updated_at      TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id)
);

-- ============================================
-- ストリークフリーズ
-- ============================================
CREATE TABLE streak_freezes (
  id            TEXT PRIMARY KEY,          -- ULID
  user_id       TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  freeze_date   TEXT NOT NULL,             -- 適用日 (YYYY-MM-DD)
  month         TEXT NOT NULL,             -- 対象月 (YYYY-MM)
  created_at    TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id, freeze_date)
);

CREATE INDEX idx_freezes_user_month ON streak_freezes(user_id, month);

-- ============================================
-- 日別統計（集計キャッシュ）
-- ============================================
CREATE TABLE reading_stats_daily (
  id              TEXT PRIMARY KEY,        -- ULID
  user_id         TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  stat_date       TEXT NOT NULL,           -- YYYY-MM-DD
  total_seconds   INTEGER NOT NULL DEFAULT 0,
  total_pages     INTEGER NOT NULL DEFAULT 0,
  session_count   INTEGER NOT NULL DEFAULT 0,
  books_finished  INTEGER NOT NULL DEFAULT 0,
  methods         TEXT,                    -- JSON: {"kindle": 1200, "in_app": 600}
  updated_at      TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id, stat_date)
);

CREATE INDEX idx_stats_user_date ON reading_stats_daily(user_id, stat_date);

-- ============================================
-- 通知設定
-- ============================================
CREATE TABLE notification_settings (
  id                    TEXT PRIMARY KEY,
  user_id               TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  reminder_enabled      INTEGER NOT NULL DEFAULT 1,
  reminder_time         TEXT NOT NULL DEFAULT '21:00',
  streak_warning_enabled INTEGER NOT NULL DEFAULT 1,
  streak_warning_time   TEXT NOT NULL DEFAULT '22:00',
  weekly_report_enabled INTEGER NOT NULL DEFAULT 0,
  expo_push_token       TEXT,
  updated_at            TEXT NOT NULL DEFAULT (datetime('now')),
  UNIQUE(user_id)
);
```

### 2.3 ID 生成戦略

**ULID** を採用。UUID v4 と比較して以下の利点がある:

- 時系列ソート可能（created_at なしでも挿入順がわかる）
- SQLite の B-Tree インデックスと相性が良い（単調増加）
- 128-bit で十分な一意性

---

## 3. API 設計

### 3.1 ベース仕様

- **フレームワーク**: Hono v4 on Cloudflare Workers
- **認証**: Clerk JWT (Bearer Token) → Hono Middleware で検証
- **フォーマット**: JSON (RFC 8259)
- **エラー形式**: `{ "error": { "code": "NOT_FOUND", "message": "..." } }`
- **ページネーション**: Cursor-based (`?cursor=xxx&limit=20`)
- **ベースURL**: `https://api.bookloop.app/v1`

### 3.2 エンドポイント一覧

#### 認証 / ユーザー

| Method | Path | 説明 |
|---|---|---|
| `POST` | `/auth/signup` | Clerk Webhook 経由でユーザー初期化 |
| `GET` | `/users/me` | 自分のプロフィール取得 |
| `PATCH` | `/users/me` | プロフィール更新 |
| `DELETE` | `/users/me` | アカウント削除 |

#### 書籍

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/books` | 本棚一覧 (`?status=reading&sort=updated_at`) |
| `POST` | `/books` | 書籍追加 |
| `GET` | `/books/:id` | 書籍詳細 |
| `PATCH` | `/books/:id` | 書籍更新（ステータス・ページ等） |
| `DELETE` | `/books/:id` | 書籍削除 |
| `GET` | `/books/search` | 外部API書籍検索 (`?q=xxx&by=title`) |

#### 読書セッション

| Method | Path | 説明 |
|---|---|---|
| `POST` | `/sessions` | セッション開始 or あとから記録 |
| `PATCH` | `/sessions/:id` | セッション更新（一時停止・再開） |
| `POST` | `/sessions/:id/complete` | セッション完了 |
| `GET` | `/sessions` | セッション履歴 (`?book_id=xxx`) |

#### ストリーク

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/streaks` | 現在のストリーク情報 |
| `POST` | `/streaks/freeze` | フリーズ発動 |
| `GET` | `/streaks/freeze` | 今月のフリーズ残数 |

#### メモ

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/books/:bookId/notes` | 書籍のメモ一覧 |
| `POST` | `/books/:bookId/notes` | メモ追加 |
| `PATCH` | `/notes/:id` | メモ編集 |
| `DELETE` | `/notes/:id` | メモ削除 |

#### 統計

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/stats/summary` | サマリー (`?period=week\|month\|all`) |
| `GET` | `/stats/daily` | 日別統計 (`?from=2026-02-01&to=2026-02-28`) |
| `GET` | `/stats/heatmap` | ヒートマップデータ (`?year=2026&month=2`) |
| `GET` | `/stats/methods` | 読書方法別の内訳 |

#### 目標 / 設定

| Method | Path | 説明 |
|---|---|---|
| `GET` | `/goals` | 現在の目標取得 |
| `PUT` | `/goals` | 目標更新 |
| `GET` | `/notifications/settings` | 通知設定取得 |
| `PUT` | `/notifications/settings` | 通知設定更新 |

### 3.3 主要 API のリクエスト/レスポンス例

#### セッション開始

```json
// POST /v1/sessions
// Request
{
  "book_id": "01HXYZ...",
  "reading_method": "kindle",
  "start_page": 166
}

// Response 201
{
  "id": "01HXYZ...",
  "book_id": "01HXYZ...",
  "started_at": "2026-02-24T21:00:00Z",
  "status": "active",
  "reading_method": "kindle"
}
```

#### セッション完了

```json
// POST /v1/sessions/01HXYZ.../complete
// Request
{
  "end_page": 189,
  "note": "仮説ドリブンのアプローチが印象的"
}

// Response 200
{
  "session": {
    "id": "01HXYZ...",
    "duration_sec": 1427,
    "pages_read": 23,
    "status": "completed"
  },
  "streak": {
    "current_count": 13,
    "longest_count": 28,
    "is_new_record": false
  },
  "book": {
    "current_page": 189,
    "progress_percent": 76.2
  }
}
```

#### あとから記録

```json
// POST /v1/sessions
// Request
{
  "book_id": "01HXYZ...",
  "reading_method": "kindle",
  "is_manual": true,
  "session_date": "2026-02-23",
  "duration_sec": 2100,
  "start_page": 166,
  "end_page": 180
}
```

---

## 4. ストリーク計算ロジック

### 4.1 日次バッチ（Cloudflare Cron Trigger）

毎日 UTC 15:00（JST 0:00）に全ユーザーのストリークを評価する。

```
ストリーク更新ロジック:

1. 対象ユーザーごとに「昨日」の読書記録を確認
2. IF 読書記録あり → current_count + 1
3. ELSE IF ストリークフリーズあり → current_count 維持
4. ELSE → current_count = 0（リセット）
5. longest_count = MAX(current_count, longest_count)
```

### 4.2 ストリークフリーズのルール

```
- 月あたり最大 2 回
- 事前発動: 当日 23:59（ユーザーTZ）まで
- 消費条件: その日に読書記録がない場合のみ消費
  （フリーズを発動したが読書もした場合 → 消費しない）
- カウント: freeze_date の month カラムで月別に集計
```

---

## 5. プロジェクト構成

```
bookloop/
├── apps/
│   ├── mobile/                  # Expo (React Native)
│   │   ├── app/                 # Expo Router (ファイルベース)
│   │   │   ├── (auth)/          # 認証前の画面
│   │   │   │   ├── login.tsx
│   │   │   │   └── onboarding.tsx
│   │   │   ├── (tabs)/          # メインタブ
│   │   │   │   ├── index.tsx        # ホーム
│   │   │   │   ├── bookshelf.tsx    # 本棚
│   │   │   │   ├── stats.tsx        # 統計
│   │   │   │   └── profile.tsx      # プロフィール/設定
│   │   │   ├── book/
│   │   │   │   ├── [id].tsx         # 書籍詳細
│   │   │   │   └── search.tsx       # 書籍検索
│   │   │   ├── session/
│   │   │   │   ├── start.tsx        # セッション開始
│   │   │   │   ├── reading.tsx      # 読書中
│   │   │   │   ├── external.tsx     # 外部アプリ読書中
│   │   │   │   ├── complete.tsx     # セッション完了
│   │   │   │   └── manual.tsx       # あとから記録
│   │   │   └── _layout.tsx
│   │   ├── components/
│   │   │   ├── ui/              # 汎用UI (Button, Card, Input...)
│   │   │   ├── book/            # 書籍関連コンポーネント
│   │   │   ├── session/         # セッション関連
│   │   │   └── stats/           # 統計グラフ等
│   │   ├── hooks/               # カスタムフック
│   │   ├── stores/              # Zustand ストア
│   │   ├── lib/
│   │   │   ├── api.ts           # API クライアント
│   │   │   ├── db.ts            # libSQL Embedded Replica
│   │   │   └── auth.ts          # Clerk 設定
│   │   └── app.json
│   │
│   └── api/                     # Hono (Cloudflare Workers)
│       ├── src/
│       │   ├── index.ts         # エントリーポイント
│       │   ├── routes/
│       │   │   ├── auth.ts
│       │   │   ├── books.ts
│       │   │   ├── sessions.ts
│       │   │   ├── streaks.ts
│       │   │   ├── notes.ts
│       │   │   ├── stats.ts
│       │   │   └── goals.ts
│       │   ├── middleware/
│       │   │   ├── auth.ts      # Clerk JWT 検証
│       │   │   └── error.ts     # エラーハンドリング
│       │   ├── services/        # ビジネスロジック
│       │   ├── db/
│       │   │   ├── schema.sql
│       │   │   └── client.ts    # Turso クライアント
│       │   └── lib/
│       │       ├── ulid.ts
│       │       └── google-books.ts
│       └── wrangler.toml
│
├── packages/
│   └── shared/                  # 型定義・バリデーション共有
│       ├── types/
│       └── validators/          # Zod スキーマ
│
├── turbo.json                   # Turborepo 設定
└── package.json
```

---

## 6. 非機能要件

| 項目 | 目標値 | 実現手段 |
|---|---|---|
| **レスポンス** | API p95 < 200ms | Cloudflare Workers (エッジ) + Turso |
| **オフライン** | READ は完全オフライン対応 | Embedded Replica |
| **コスト（月額）** | < $10 (MVP) | CF Workers Free / Turso Free / Clerk Free |
| **可用性** | 99.5%+ | Turso マルチリージョン + CF |

### 6.1 MVP 想定コスト

| サービス | プラン | 月額 |
|---|---|---|
| Cloudflare Workers | Free (10万リクエスト/日) | $0 |
| Turso | Starter (9GB, 500 DBs) | $0 |
| Clerk | Free (10,000 MAU) | $0 |
| Cloudflare R2 | Free (10GB) | $0 |
| Expo (EAS Build) | Free (30 builds/月) | $0 |
| **合計** | | **$0** |

---

## 7. MVP 開発マイルストーン

| Week | タスク | 成果物 |
|---|---|---|
| **Week 1** | プロジェクト初期化・DB・認証 | Turborepo セットアップ、Turso スキーマ、Clerk 連携、ログイン画面 |
| **Week 2** | 書籍管理 | 書籍検索 (Google Books API)、本棚 CRUD、書籍詳細 |
| **Week 3** | 読書セッション | タイマー (アプリ内・外部)、セッション完了、あとから記録 |
| **Week 4** | ストリーク・統計 | ストリーク計算 Cron、フリーズ、統計ダッシュボード |
| **Week 5** | 通知・設定・仕上げ | プッシュ通知、プロフィール/設定、オンボーディング |
| **Week 6** | テスト・ビルド・リリース準備 | E2E テスト、EAS Build、TestFlight/内部テスト |
